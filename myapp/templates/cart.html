{% extends 'base.html' %} {% load static %} {% block body %}
<section>
  <!-- NAVIGATION -->
  <!-- END OF NAVIGATION -->
  <header class="cart-bread-crumbs">
    <div class="checkout-top">
      <h3 class="checkout-current">Cart Summary</h3>
      <a class="checkout-button" href="{% url 'checkout' %}"
        >Checkout &#8594;</a
      >
    </div>

    <ol class="links">
      <li>
        <a class="underline" href="{% url 'checkout' %}"
          >2. Shipping Information &#8594;</a
        >
      </li>
      <li>
        <p>3. Select Payment Method</p>
      </li>
      <li>
        <p>4. Order Confirmed</p>
      </li>
    </ol>
  </header>

  <div class="cart-header">
    <h4>Items: {{ cartItems }}</h4>
    <h4>Total: €{{ order.get_cart_total }}</h4>
  </div>

  <div style="margin: 0px 100px 100px 100px">
    <div class="table-heading">
      <p style="display: hidden">Image</p>
      <p>Product</p>
      <p>Quantity</p>
      <p>Subtotal</p>
    </div>
    {% for item in items %}

    <hr style="margin-top: 15px" />

    <div class="order-item">
      <!-- image -->
      <div>
        <img class="order-image" src="{{ item.product.imageURL }}" alt="" />
      </div>
      <!-- end of image -->

      <!-- name -->
      <div>
        <p class="cart-item-name">{{ item.product.name }}</p>
        <p class="cart-item-price">€{{ item.product.price }}</p>
      </div>
      <!-- end of name -->

      <!-- quantity -->
      <div class="order-quantity">
        <i
          data-product="{{ item.product.id }}"
          data-action="remove"
          class="fa-solid fa-minus update-cart"
        ></i>
        <p>{{ item.quantity }}</p>
        <i
          data-product="{{ item.product.id }}"
          data-action="add"
          class="fa-solid fa-plus update-cart"
        ></i>
      </div>
      <!-- end of quantity -->

      <!-- subtotal -->
      <div>
        <p>€{{ item.get_total }}</p>
      </div>
      <!-- end of subtotal -->
    </div>
    {% endfor %}
  </div>

  <!-- javascript -->
  <script type="text/javascript">
    var shipping = "{{ order.shipping }}";
    var total = "{{ order.get_cart_total }}";

    if (shipping == "False") {
      document.getElementById("shipping-info").innerHTML = "";
    }

    if (user != "AnonymousUser") {
      document.getElementById("user-info").innerHTML = "";
    }

    if (shipping == "False" && user != "AnonymousUser") {
      // Hide entire form if user is logged in and shipping is false
      document.getElementById("form-wrapper").classList.add("hidden");
      // Show payment if logged in user wants to buy an item that does not
      // require shipping
      document.getElementById("payment-info").classList.remove("hidden");
    }

    var form = document.getElementById("form");

    csrftoken = form.getElementsByTagName("input")[0].value;
    console.log("Newtoken:", form.getElementByTagName("input")[0].value);

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      console.log("Form submitted...");
      document.getElementById("form-button").classList.add("hidden");
      document.getElementById("payment-info").classList.remove("hidden");
    });

    document
      .getElementById("make-payment")
      .addEventListener("click", function (e) {
        submitFormData();
      });
    function submitFormData() {
      console.log("Payment button clicked");

      var userFormData = {
        name: null,
        email: null,
        total: total,
      };

      var shippingInfo = {
        address: null,
        city: null,
        state: null,
        zipcode: null,
      };

      if (shipping != "False") {
        shippingInfo.address = form.address.value;
        shippingInfo.city = form.city.value;
        shippingInfo.state = form.state.value;
        shippingInfo.zipcode = form.zipcode.value;
      }

      if (user == "AnonymousUser") {
        userFormData.name = form.name.value;
        userFormData.email = form.email.value;
      }

      var url = "/process_order/";
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({ form: userFormData, shipping: shippingInfo }),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Success:", data);
          alert("Trasaction completed");
          window.location.href = "{% url 'store' %}";
        });
    }
  </script>
  <!-- javascript -->
</section>
{% endblock %}
